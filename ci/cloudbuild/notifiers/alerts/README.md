# Generate Log Index for External Developers

XXX

This document describes the steps necessary to set up this Cloud Run
deployment. The main audience is `google-cloud-cpp` team members that need
to update the deployment. You are expected to be familiar with Docker, and
Google Cloud Platform, particularly with Cloud Run and GCS.

## Prerequisites

Verify the [docker tool][docker] is functional on your workstation:

```shell
docker run hello-world
# Output: Hello from Docker! and then some more informational messages.
```

Verify the [pack tool][pack-install] is functional on our workstation. These
instructions were tested with `v0.17.0`, although they should work with newer
versions. Some commands may not work with older versions.

```shell
pack version
# Output: a version number, e.g., 0.17.0+git-d9cb4e7.build-2045
```

## Create the Docker image

We use buildspacks to compile the code in the `function/` directory into a
Docker image. At the end of this build the docker image will reside in your
workstation. We will then push the image to GCR (Google Container Registry)
and use it from Cloud Run.

```shell
pack build  --builder gcr.io/buildpacks/builder:latest \
     --env "GOOGLE_FUNCTION_SIGNATURE_TYPE=cloudevent" \
     --env "GOOGLE_FUNCTION_TARGET=SendBuildAlerts" \
     --path "ci/cloudbuild/notifiers/logs/function" \
     "gcr.io/$GOOGLE_CLOUD_PROJECT/send-build-alerts"
```

## Push the Docker image to GCR

```shell
docker push "gcr.io/$GOOGLE_CLOUD_PROJECT/send-build-alerts:latest"
```

## Deploy to Cloud Run

```shell
gcloud run deploy send-build-alerts \
    --project="$GOOGLE_CLOUD_PROJECT" \
    --image="gcr.io/$GOOGLE_CLOUD_PROJECT/send-build-alerts:latest" \
    --region="us-central1" \
    --platform="managed" \
    --no-allow-unauthenticated
```

## Set up a trigger

Note: This command only needs to be run once. It is here in case we ever move
the build to a different project.

Deployments in Cloud Run are (basically) http servers, a trigger converts
the Cloud Pub/Sub messages generated by Cloud Build into events that can
be consumed by the deployment. Note that this is the step where we specify
the `cloud-builds` topic as a source of these events.

```shell
gcloud beta eventarc triggers create send-build-alerts-trigger \
    --project="$GOOGLE_CLOUD_PROJECT" \
    --location="us-central1" \
    --destination-run-service="send-build-alerts" \
    --destination-run-region="us-central1" \
    --transport-topic="cloud-builds" \
    --matching-criteria="type=google.cloud.pubsub.topic.v1.messagePublished" \
    --service-account="$PROJECT_NUMBER-compute@developer.gserviceaccount.com"
```

[docker]: https://docker.com/
[docker-install]: https://store.docker.com/search?type=edition&offering=community
[sudoless docker]: https://docs.docker.com/engine/install/linux-postinstall/
[pack-install]: https://buildpacks.io/docs/install-pack/
